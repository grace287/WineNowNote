{% extends "base.html" %}
{% block title %}캘린더 — WineNowNote{% endblock %}
{% block extra_css %}
<style>
    .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
    .cal-header h2 { margin: 0; font-size: 1.3rem; font-weight: 600; color: var(--text-primary); }
    .cal-nav { display: flex; gap: 0.5rem; }
    .cal-notice { margin-bottom: 1rem; padding: 0.75rem 1rem; background: #FFF8F0; border: 1px solid var(--wine-light); border-radius: var(--radius-sm); font-size: 0.9rem; color: var(--text-secondary); }
    .cal-notice a { color: var(--wine-primary); font-weight: 600; }
    .cal-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-sm); }
    .cal-table th, .cal-table td { border: 1px solid var(--border); padding: 0.6rem; text-align: center; }
    .cal-table th { background: var(--surface); font-size: 0.85rem; color: var(--text-secondary); font-weight: 600; }
    .cal-table td { min-height: 88px; vertical-align: top; background: #fff; }
    .cal-table td.other-month { opacity: 0.5; color: var(--text-tertiary); }
    .cal-table td.today { background: rgba(139, 30, 63, 0.08); }
    .cal-table td.cal-day { cursor: pointer; transition: background 0.15s; }
    .cal-table td.cal-day:hover { background: rgba(139, 30, 63, 0.06); }
    .day-num { font-weight: 600; margin-bottom: 4px; font-size: 0.95rem; color: var(--text-primary); }
    .day-notes { font-size: 0.8rem; text-align: left; }
    .day-notes .day-note-item { margin-bottom: 2px; }
    .day-notes a, .day-notes .day-note-item { color: var(--wine-primary); text-decoration: none; }
    .day-notes a:hover { text-decoration: underline; }
</style>
{% endblock %}
{% block content %}
<div class="cal-header">
    <h2 id="cal-title">캘린더</h2>
    <div class="cal-nav">
        <button type="button" id="cal-prev" class="btn btn-secondary">이전</button>
        <button type="button" id="cal-today" class="btn btn-secondary">이번 달</button>
        <button type="button" id="cal-next" class="btn btn-secondary">다음</button>
        <button type="button" id="cal-open-note-modal" class="btn btn-primary">시음 노트 작성</button>
    </div>
</div>
<div id="cal-guest-msg" class="cal-notice" style="display: none;">
    로그인하면 이 달의 시음 노트가 날짜별로 표시됩니다. <a href="{% url 'login' %}">로그인</a> · <a href="{% url 'register' %}">회원가입</a>
</div>
<div id="cal-container">
    <table class="cal-table">
        <thead><tr><th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th></tr></thead>
        <tbody id="cal-body"></tbody>
    </table>
</div>

<div id="note-form-modal" class="note-modal-overlay">
    <div class="note-modal-box">
        <div class="note-modal-header">
            <h3>시음 노트 작성</h3>
            <button type="button" class="note-modal-close" aria-label="닫기">×</button>
        </div>
        <div class="note-modal-body">{% include "_note_form_inner.html" %}</div>
    </div>
</div>

<script>
(function() {
    const access = localStorage.getItem('access');
    const guestMsg = document.getElementById('cal-guest-msg');
    const calBody = document.getElementById('cal-body');
    const calTitle = document.getElementById('cal-title');
    const modal = document.getElementById('note-form-modal');

    let year = new Date().getFullYear();
    let month = new Date().getMonth() + 1;

    function openNoteFormModal(dateStr) {
        if (!modal) return;
        var dateInput = document.getElementById('tasted_date');
        if (dateInput) dateInput.value = dateStr || new Date().toISOString().slice(0, 10);
        modal.style.display = 'flex';
    }
    function closeNoteFormModal() {
        if (modal) modal.style.display = 'none';
    }
    window.openNoteFormModal = openNoteFormModal;

    document.getElementById('cal-open-note-modal').onclick = function() { openNoteFormModal(); };
    modal.querySelector('.note-modal-close').onclick = closeNoteFormModal;
    modal.addEventListener('click', function(e) { if (e.target === modal) closeNoteFormModal(); });

    function renderTitle() { calTitle.textContent = year + '년 ' + month + '월'; }

    function getAuthHeaders() {
        const h = { 'Content-Type': 'application/json' };
        if (access) h['Authorization'] = 'Bearer ' + access;
        return h;
    }

    function firstDayOfMonth(y, m) { return new Date(y, m - 1, 1).getDay(); }
    function daysInMonth(y, m) { return new Date(y, m, 0).getDate(); }
    function daysInPrevMonth(y, m) { return m === 1 ? new Date(y - 1, 11, 0).getDate() : new Date(y, m - 2, 0).getDate(); }

    function buildCalendarGrid(y, m, daysData) {
        const first = firstDayOfMonth(y, m);
        const total = daysInMonth(y, m);
        const prevTotal = daysInPrevMonth(y, m);
        const rows = [];
        let row = [];
        for (let i = 0; i < first; i++) {
            const d = prevTotal - first + i + 1;
            const prevM = m === 1 ? 12 : m - 1;
            const prevY = m === 1 ? y - 1 : y;
            const dateStr = prevY + '-' + String(prevM).padStart(2,'0') + '-' + String(d).padStart(2,'0');
            row.push('<td class="other-month cal-day" data-date="' + dateStr + '"><span class="day-num">' + d + '</span><div class="day-notes"></div></td>');
        }
        const today = new Date();
        for (let day = 1; day <= total; day++) {
            const dateStr = y + '-' + String(m).padStart(2,'0') + '-' + String(day).padStart(2,'0');
            const notes = (daysData && daysData[dateStr]) || [];
            const isToday = today.getFullYear() === y && today.getMonth() + 1 === m && today.getDate() === day;
            let notesHtml = '';
            notes.forEach(function(n) {
                var name = (n.wine_name || '노트');
                var rating = (n.rating != null ? ' ★' + n.rating : '');
                notesHtml += '<div class="day-note-item">' + name + rating + '</div>';
            });
            row.push('<td class="cal-day' + (isToday ? ' today' : '') + '" data-date="' + dateStr + '"><span class="day-num">' + day + '</span><div class="day-notes">' + notesHtml + '</div></td>');
            if (row.length === 7) { rows.push('<tr>' + row.join('') + '</tr>'); row = []; }
        }
        if (row.length) {
            const nextM = m === 12 ? 1 : m + 1;
            const nextY = m === 12 ? y + 1 : y;
            for (let i = row.length; i < 7; i++) {
                const d = i - row.length + 1;
                const dateStr = nextY + '-' + String(nextM).padStart(2,'0') + '-' + String(d).padStart(2,'0');
                row.push('<td class="other-month cal-day" data-date="' + dateStr + '"><span class="day-num">' + d + '</span><div class="day-notes"></div></td>');
            }
            rows.push('<tr>' + row.join('') + '</tr>');
        }
        return rows.join('');
    }

    function bindDayClicks() {
        calBody.querySelectorAll('.cal-day').forEach(function(td) {
            td.onclick = function() { openNoteFormModal(td.getAttribute('data-date')); };
        });
    }

    function loadCalendar() {
        guestMsg.style.display = access ? 'none' : 'block';
        if (!access) {
            renderTitle();
            calBody.innerHTML = buildCalendarGrid(year, month, {});
            bindDayClicks();
            return;
        }
        fetch('/api/tasting-notes/calendar/?year=' + year + '&month=' + month, { headers: getAuthHeaders() })
            .then(function(r) {
                if (r.status === 401) {
                    guestMsg.style.display = 'block';
                    return {};
                }
                return r.json();
            })
            .then(function(data) {
                renderTitle();
                var byDate = {};
                if (data.days) data.days.forEach(function(d) { byDate[d.date] = d.notes || []; });
                calBody.innerHTML = buildCalendarGrid(year, month, byDate);
                bindDayClicks();
            })
            .catch(function() {
                renderTitle();
                calBody.innerHTML = buildCalendarGrid(year, month, {});
                bindDayClicks();
            });
    }

    document.getElementById('cal-prev').onclick = function() {
        if (month === 1) { year--; month = 12; } else month--;
        loadCalendar();
    };
    document.getElementById('cal-next').onclick = function() {
        if (month === 12) { year++; month = 1; } else month++;
        loadCalendar();
    };
    document.getElementById('cal-today').onclick = function() {
        var t = new Date();
        year = t.getFullYear();
        month = t.getMonth() + 1;
        loadCalendar();
    };

    window.addEventListener('noteFormSaved', function() { loadCalendar(); });
    loadCalendar();
})();
</script>
{% endblock %}
