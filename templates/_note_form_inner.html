{% comment %}ê³µí†µ ì‹œìŒ ë…¸íŠ¸ í¼ â€” ëª¨ë¸: wines.Wine(ë¡œê·¸ì¸ ë¬´ê´€), notes.TastingNote(user FK). 5ë‹¨ê³„, ë³„ í‰ì , ì €ì¥ ë²„íŠ¼ {% endcomment %}
<div id="form-guest-notice" class="form-guest-notice" style="display: none;">
    ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. <a href="{% url 'login' %}">ë¡œê·¸ì¸</a> Â· <a href="{% url 'register' %}">íšŒì›ê°€ì…</a>
</div>
<div id="form-success" class="alert alert-success" style="display: none;">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
<div id="form-error" class="alert alert-error" style="display: none;"></div>
<form id="note-form" class="note-form-inner note-form-steps">
    <div class="steps-bar">
        <div class="step active" data-step="1"><span class="step-num">1</span><span class="step-label">ê¸°ë³¸ ì •ë³´</span></div>
        <div class="step" data-step="2"><span class="step-num">2</span><span class="step-label">ì™¸ê´€ í‰ê°€</span></div>
        <div class="step" data-step="3"><span class="step-num">3</span><span class="step-label">ì•„ë¡œë§ˆ</span></div>
        <div class="step" data-step="4"><span class="step-num">4</span><span class="step-label">ë§›</span></div>
        <div class="step" data-step="5"><span class="step-num">5</span><span class="step-label">ì¢…í•©í‰ê°€</span></div>
    </div>

    <div class="step-content active" data-step="1">
        <div class="form-section">
            <h3 class="form-section-title">ê¸°ë³¸ ì™€ì¸ ì •ë³´</h3>
            <div class="form-group">
                <label for="wine-select">ì™€ì¸ ì„ íƒ *</label>
                <select name="wine" id="wine-select" required>
                    <option value="">â€” ì™€ì¸ì„ ì„ íƒí•˜ì„¸ìš” â€”</option>
                </select>
                <p id="wine-empty-msg" class="text-muted" style="margin-top: 6px; font-size: 12px; display: none;">ë“±ë¡ëœ ì™€ì¸ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</p>
            </div>
            <div class="form-group">
                <label class="label-block">ì™€ì¸ ì¢…ë¥˜ (í•„í„°)</label>
                <div class="wine-type-grid" id="wine-type-filter">
                    <button type="button" class="wine-type-btn active" data-type="">ì „ì²´</button>
                    <button type="button" class="wine-type-btn" data-type="red">ğŸ· ë ˆë“œ</button>
                    <button type="button" class="wine-type-btn" data-type="white">ğŸ¥‚ í™”ì´íŠ¸</button>
                    <button type="button" class="wine-type-btn" data-type="sparkling">âœ¨ ìŠ¤íŒŒí´ë§</button>
                    <button type="button" class="wine-type-btn" data-type="rose">ğŸŒ¸ ë¡œì œ</button>
                    <button type="button" class="wine-type-btn" data-type="champagne">ğŸ¾ ìƒ´í˜ì¸</button>
                    <button type="button" class="wine-type-btn" data-type="dessert">ğŸ¯ ë””ì €íŠ¸</button>
                    <button type="button" class="wine-type-btn" data-type="fortified">ğŸŒŸ ì£¼ì •ê°•í™”</button>
                    <button type="button" class="wine-type-btn" data-type="orange">ğŸŸ  ì˜¤ë Œì§€</button>
                    <button type="button" class="wine-type-btn" data-type="natural">ğŸŒ¿ ë‚´ì¶”ëŸ´</button>
                    <button type="button" class="wine-type-btn" data-type="other">ğŸ‡ ê¸°íƒ€</button>
                </div>
            </div>
            <div class="form-row-2">
                <div class="form-group">
                    <label for="tasted_date">ì‹œìŒì¼ *</label>
                    <input type="date" name="tasted_date" id="tasted_date" required>
                </div>
                <div class="form-group">
                    <label class="label-block">í‰ì  (1~5) *</label>
                    <div class="star-rating" id="star-rating" role="slider" aria-valuenow="3" aria-valuemin="1" aria-valuemax="5" tabindex="0">
                        <span class="star" data-value="1">â˜…</span>
                        <span class="star" data-value="2">â˜…</span>
                        <span class="star" data-value="3">â˜…</span>
                        <span class="star" data-value="4">â˜…</span>
                        <span class="star" data-value="5">â˜…</span>
                    </div>
                    <input type="hidden" name="rating" id="rating" value="3" required>
                </div>
            </div>
            <div class="form-group">
                <label for="location">ì¥ì†Œ</label>
                <select name="location" id="location">
                    <option value="other">ê¸°íƒ€</option>
                    <option value="home">ì§‘</option>
                    <option value="restaurant">ë ˆìŠ¤í† ë‘</option>
                    <option value="bar">ë°”</option>
                    <option value="event">ì´ë²¤íŠ¸</option>
                </select>
            </div>
            <div class="form-group">
                <label for="location_detail">ì¥ì†Œ ìƒì„¸</label>
                <input type="text" name="location_detail" id="location_detail" placeholder="ì˜ˆ: OO ë ˆìŠ¤í† ë‘">
            </div>
        </div>
    </div>

    <div class="step-content" data-step="2">
        <div class="form-section">
            <div class="form-section-title">ì™¸ê´€ í‰ê°€</div>
            <div class="form-group">
                <label>ìƒ‰ì˜ ê°•ë„</label>
                <div class="slider-wrap">
                    <input type="range" name="appearance_intensity" id="appearance_intensity" min="1" max="5" value="3" class="slider-input">
                    <span class="slider-val" id="val-appearance_intensity">3</span>
                </div>
                <div class="slider-labels">
                    <span>ë§¤ìš° ì—°í•¨</span><span>ì—°í•¨</span><span>ë³´í†µ</span><span>ì§„í•¨</span><span>ë§¤ìš° ì§„í•¨</span>
                </div>
            </div>
            <div class="form-group">
                <label>íˆ¬ëª…ë„</label>
                <div class="slider-wrap">
                    <input type="range" name="appearance_clarity_slider" id="appearance_clarity_slider" min="1" max="3" value="2" class="slider-input">
                </div>
                <div class="slider-labels slider-labels-3">
                    <span>íƒí•¨</span><span>íë¦¼</span><span>ë§‘ìŒ</span>
                </div>
                <input type="hidden" name="appearance_clarity" id="appearance_clarity" value="hazy">
            </div>
        </div>
    </div>

    <div class="step-content" data-step="3">
        <div class="form-section">
            <div class="form-section-title">ì•„ë¡œë§ˆ</div>
            <div class="form-group">
                <label>í–¥ ê°•ë„</label>
                <div class="slider-wrap">
                    <input type="range" name="aroma_intensity" id="aroma_intensity" min="1" max="5" value="3" class="slider-input">
                    <span class="slider-val" id="val-aroma_intensity">3</span>
                </div>
                <div class="slider-labels">
                    <span>ë§¤ìš° ì•½í•¨</span><span>ì•½í•¨</span><span>ë³´í†µ</span><span>ê°•í•¨</span><span>ë§¤ìš° ê°•í•¨</span>
                </div>
            </div>
            <div class="form-group">
                <label for="aroma_notes">ì•„ë¡œë§ˆ ë…¸íŠ¸</label>
                <textarea name="aroma_notes" id="aroma_notes" placeholder="ê°ì§€í•œ í–¥ì„ ë©”ëª¨í•´ ë³´ì„¸ìš”" rows="3"></textarea>
            </div>
        </div>
    </div>

    <div class="step-content" data-step="4">
        <div class="form-section">
            <div class="form-section-title">ë§›</div>
            <div class="taste-sliders">
                <div class="form-group">
                    <label>ë°”ë””</label>
                    <div class="slider-wrap"><input type="range" name="body" min="1" max="5" value="3" class="slider-input"><span class="slider-val" id="val-body">3</span></div>
                </div>
                <div class="form-group">
                    <label>ì‚°ë„</label>
                    <div class="slider-wrap"><input type="range" name="acidity" min="1" max="5" value="3" class="slider-input"><span class="slider-val" id="val-acidity">3</span></div>
                </div>
                <div class="form-group">
                    <label>íƒ€ë‹Œ</label>
                    <div class="slider-wrap"><input type="range" name="tannin" min="1" max="5" value="3" class="slider-input"><span class="slider-val" id="val-tannin">3</span></div>
                </div>
                <div class="form-group">
                    <label>ë‹¹ë„</label>
                    <div class="slider-wrap"><input type="range" name="sweetness" min="1" max="5" value="3" class="slider-input"><span class="slider-val" id="val-sweetness">3</span></div>
                </div>
            </div>
            <div class="form-group">
                <label for="pairing">í˜ì–´ë§ ìŒì‹</label>
                <input type="text" name="pairing" id="pairing" placeholder="ì˜ˆ: ìŠ¤í…Œì´í¬, ì¹˜ì¦ˆ">
            </div>
        </div>
    </div>

    <div class="step-content" data-step="5">
        <div class="form-section">
            <div class="form-section-title">ì¢…í•© í‰ê°€</div>
            <div class="form-group">
                <label for="notes">ì¢…í•© ë©”ëª¨</label>
                <textarea name="notes" id="notes" placeholder="ì „ì²´ì ì¸ ì¸ìƒ, ì¶”ì²œ ì—¬ë¶€ ë“±ì„ ììœ ë¡­ê²Œ ì ì–´ ì£¼ì„¸ìš”" rows="4"></textarea>
            </div>
        </div>
    </div>

    <div class="form-step-actions">
        <button type="button" class="btn btn-secondary btn-step-prev" style="display: none;">â† ì´ì „</button>
        <button type="button" class="btn btn-primary btn-step-next">ë‹¤ìŒ â†’</button>
        <button type="submit" class="btn btn-primary btn-step-submit btn-save" style="display: none;">ğŸ’¾ ì €ì¥</button>
        <button type="button" class="btn btn-secondary btn-close-modal" style="display: none;">ì·¨ì†Œ</button>
        <a href="{% url 'home' %}" class="btn btn-secondary form-cancel-link" style="display: none;">ì·¨ì†Œ</a>
    </div>
</form>
<script>
(function() {
    const access = localStorage.getItem('access');
    const formEl = document.getElementById('note-form');
    if (!formEl) return;
    const guestNotice = document.getElementById('form-guest-notice');
    const formSuccess = document.getElementById('form-success');
    const formError = document.getElementById('form-error');
    const wineSelect = document.getElementById('wine-select');
    const wineEmptyMsg = document.getElementById('wine-empty-msg');
    const modal = document.getElementById('note-form-modal');
    const isInModal = modal && modal.contains(formEl);

    var currentStep = 1;
    var totalSteps = 5;
    var steps = formEl.querySelectorAll('.step');
    var contents = formEl.querySelectorAll('.step-content');
    var btnPrev = formEl.querySelector('.btn-step-prev');
    var btnNext = formEl.querySelector('.btn-step-next');
    var btnSubmit = formEl.querySelector('.btn-step-submit');

    var allWines = [];

    function showStep(n) {
        currentStep = n;
        steps.forEach(function(s) {
            s.classList.toggle('active', parseInt(s.getAttribute('data-step'), 10) === n);
        });
        contents.forEach(function(c) {
            c.classList.toggle('active', parseInt(c.getAttribute('data-step'), 10) === n);
        });
        btnPrev.style.display = n === 1 ? 'none' : 'inline-block';
        btnNext.style.display = n === totalSteps ? 'none' : 'inline-block';
        btnSubmit.style.display = n === totalSteps ? 'inline-block' : 'none';
    }
    btnPrev.onclick = function() { if (currentStep > 1) showStep(currentStep - 1); };
    btnNext.onclick = function() {
        if (currentStep < totalSteps) showStep(currentStep + 1);
    };
    steps.forEach(function(s) {
        s.onclick = function() {
            var n = parseInt(s.getAttribute('data-step'), 10);
            if (n <= currentStep || n === 1) showStep(n);
        };
    });

    var clarityMap = { 1: 'cloudy', 2: 'hazy', 3: 'clear' };
    var claritySlider = document.getElementById('appearance_clarity_slider');
    var clarityHidden = document.getElementById('appearance_clarity');
    if (claritySlider && clarityHidden) {
        claritySlider.addEventListener('input', function() {
            clarityHidden.value = clarityMap[parseInt(this.value, 10)] || 'hazy';
        });
    }

    function authHeaders() {
        var h = { 'Content-Type': 'application/json' };
        if (access) h['Authorization'] = 'Bearer ' + access;
        return h;
    }

    function loadWines() {
        fetch('/api/wines/', { headers: { 'Content-Type': 'application/json' } })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                allWines = data.results || data || [];
                if (Array.isArray(data) && data.length) allWines = data;
                renderWineSelect('');
                if (wineEmptyMsg) wineEmptyMsg.style.display = allWines.length ? 'none' : 'block';
            })
            .catch(function() {
                allWines = [];
                if (wineEmptyMsg) wineEmptyMsg.style.display = 'block';
            });
    }
    function renderWineSelect(filterType) {
        if (!wineSelect) return;
        var currentVal = wineSelect.value;
        wineSelect.innerHTML = '<option value="">â€” ì™€ì¸ì„ ì„ íƒí•˜ì„¸ìš” â€”</option>';
        allWines.filter(function(w) {
            return !filterType || (w.type || '').toLowerCase() === filterType;
        }).forEach(function(w) {
            var opt = document.createElement('option');
            opt.value = w.id;
            opt.textContent = (w.name || '') + (w.vintage ? ' (' + w.vintage + ')' : '') + (w.winery ? ' Â· ' + w.winery : '');
            opt.dataset.type = (w.type || '').toLowerCase();
            wineSelect.appendChild(opt);
        });
        if (currentVal && wineSelect.querySelector('option[value="' + currentVal + '"]')) wineSelect.value = currentVal;
    }

    var typeFilter = document.getElementById('wine-type-filter');
    if (typeFilter) {
        typeFilter.querySelectorAll('.wine-type-btn').forEach(function(btn) {
            btn.onclick = function() {
                typeFilter.querySelectorAll('.wine-type-btn').forEach(function(b) { b.classList.remove('active'); });
                btn.classList.add('active');
                renderWineSelect(btn.getAttribute('data-type') || '');
            };
        });
    }

    var starRating = document.getElementById('star-rating');
    var ratingInput = document.getElementById('rating');
    if (starRating && ratingInput) {
        function setStars(v) {
            var val = parseInt(v, 10) || 0;
            ratingInput.value = val;
            starRating.setAttribute('aria-valuenow', val);
            starRating.querySelectorAll('.star').forEach(function(s) {
                s.classList.toggle('filled', parseInt(s.getAttribute('data-value'), 10) <= val);
            });
        }
        starRating.querySelectorAll('.star').forEach(function(star) {
            star.onclick = function() { setStars(star.getAttribute('data-value')); };
        });
        starRating.addEventListener('keydown', function(e) {
            var v = parseInt(ratingInput.value, 10) || 3;
            if (e.key === 'ArrowRight' || e.key === 'ArrowUp') { e.preventDefault(); setStars(Math.min(5, v + 1)); }
            if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') { e.preventDefault(); setStars(Math.max(1, v - 1)); }
        });
        setStars(3);
    }

    var today = new Date().toISOString().slice(0, 10);
    var dateInput = formEl.querySelector('[name="tasted_date"]');
    if (dateInput) dateInput.value = today;

    if (!access) {
        if (guestNotice) guestNotice.style.display = 'block';
    }
    loadWines();

    ['appearance_intensity','aroma_intensity','body','acidity','tannin','sweetness'].forEach(function(name) {
        var input = formEl.querySelector('[name="' + name + '"]');
        var span = document.getElementById('val-' + name);
        if (input && span) input.addEventListener('input', function() { span.textContent = input.value; });
    });

    var closeBtn = formEl.querySelector('.btn-close-modal');
    var cancelLink = formEl.querySelector('.form-cancel-link');
    if (closeBtn && isInModal) {
        closeBtn.style.display = 'inline-block';
        closeBtn.onclick = function() { if (modal) modal.style.display = 'none'; };
    }
    if (cancelLink && !isInModal) cancelLink.style.display = 'inline-block';

    formEl.addEventListener('submit', function(e) {
        e.preventDefault();
        if (formError) formError.style.display = 'none';
        if (formSuccess) formSuccess.style.display = 'none';

        if (!access) {
            if (formError) {
                formError.innerHTML = 'ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. <a href="{% url "login" %}" class="link">ë¡œê·¸ì¸</a> Â· <a href="{% url "register" %}" class="link">íšŒì›ê°€ì…</a>';
                formError.style.display = 'block';
            }
            return;
        }

        var fd = new FormData(formEl);
        var wineVal = fd.get('wine');
        if (!wineVal || !parseInt(wineVal, 10)) {
            if (formError) { formError.textContent = 'ì™€ì¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'; formError.style.display = 'block'; }
            return;
        }
        var tastedDate = fd.get('tasted_date');
        var body = {
            wine: parseInt(wineVal, 10),
            tasted_date: tastedDate,
            rating: parseInt(fd.get('rating'), 10),
            location: fd.get('location') || 'other',
            location_detail: fd.get('location_detail') || '',
            appearance_clarity: fd.get('appearance_clarity') || '',
            appearance_intensity: fd.get('appearance_intensity') ? parseInt(fd.get('appearance_intensity'), 10) : null,
            aroma_intensity: fd.get('aroma_intensity') ? parseInt(fd.get('aroma_intensity'), 10) : null,
            aroma_notes: fd.get('aroma_notes') || '',
            body: fd.get('body') ? parseInt(fd.get('body'), 10) : null,
            acidity: fd.get('acidity') ? parseInt(fd.get('acidity'), 10) : null,
            tannin: fd.get('tannin') ? parseInt(fd.get('tannin'), 10) : null,
            sweetness: fd.get('sweetness') ? parseInt(fd.get('sweetness'), 10) : null,
            pairing: fd.get('pairing') || '',
            notes: fd.get('notes') || '',
            custom_fields: {},
            photos: [],
            is_public: false
        };
        fetch('/api/tasting-notes/', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify(body)
        })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(o) {
            if (o.ok) {
                if (formSuccess) { formSuccess.style.display = 'block'; formSuccess.textContent = 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'; }
                formEl.reset();
                var di = formEl.querySelector('[name="tasted_date"]');
                if (di) di.value = today;
                if (ratingInput) ratingInput.value = '3';
                if (starRating) starRating.querySelectorAll('.star').forEach(function(s) {
                    s.classList.toggle('filled', parseInt(s.getAttribute('data-value'), 10) <= 3);
                });
                starRating && starRating.setAttribute('aria-valuenow', '3');
                showStep(1);
                if (isInModal && modal) {
                    modal.style.display = 'none';
                    var wineName = (o.data && o.data.wine_name) || (wineSelect && wineSelect.options[wineSelect.selectedIndex]) ? wineSelect.options[wineSelect.selectedIndex].text : '';
                    window.dispatchEvent(new CustomEvent('noteFormSaved', { detail: { date: tastedDate, wine_name: wineName, rating: body.rating } }));
                }
            } else {
                if (formError) {
                    formError.textContent = o.data.detail || (o.data.wine && o.data.wine[0]) || JSON.stringify(o.data);
                    formError.style.display = 'block';
                }
            }
        })
        .catch(function(e) {
            if (formError) { formError.textContent = 'ì €ì¥ ì‹¤íŒ¨: ' + e.message; formError.style.display = 'block'; }
        });
    });
})();
</script>
